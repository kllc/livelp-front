<html>
  <head>
    <title>Online Chat</title>
    <meta http-equiv="content-type" charset="UTF-8" />
    <link rel="icon" href="https://kllc.github.io/repo/img/favicon.ico" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100;300;400;500;700;900&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/@mdi/font@6.x/css/materialdesignicons.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css"
      rel="stylesheet"
    />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui"
    />
    <style>
      html,
      body {
        font-family: "Noto Sans JP", sans-serif;
        background: transparent;
        color: white;
        display: flex;
        justify-content: space-around;
        align-items: center;
      }
      .chat-title {
        height: 3rem;
      }
      .chat-area {
        /*   border: 1px solid #ccc; */
        /* background: white; */
        height: calc(100vh - 7rem);
        height: calc(100dvh - 7rem);
        padding: 1em;
        overflow: auto;
        /* max-width: 350px; */
        /* margin: 0 auto 2em auto; */
        /* box-shadow: 2px 2px 2px 2px rgba(0, 0, 0, 0.3); */
      }
      .chat-area li {
        /* list-style-position: inside; */
        list-style-position: outside;
        margin-left: 1em;
      }
      .chat-messagae {
        height: 3.5rem;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .message {
        width: 85%;
        border-radius: 10px;
        padding: 0.5em;
        margin-bottom: 0.5em;
        font-size: 0.8em;
      }
      .message-out {
        color: white;
        margin-left: 15%;
      }
      .message-in {
        background: #fff;
        color: black;
        border: 1px solid var(--bg-color);
      }

      .yureru-js {
        animation: yureru-js 3s infinite;
      }
      @keyframes yureru-js {
        1% {
          transform: translate(0px, 0px);
        }
        2% {
          transform: translate(1px, 1px);
        }
        3% {
          transform: translate(1px, -1px);
        }
        4% {
          transform: translate(-1px, -1px);
        }
        5% {
          transform: translate(-1px, 1px);
        }
        100% {
          transform: translate(0px, 0px);
        }
      }

      /* ボタンの波紋 */
      .pulse-btn::after {
        content: "";
        display: block;
        position: absolute;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        margin: auto;
        width: 100%;
        height: 100%;
        border: var(--border-size) solid var(--bg-color);
        border-radius: 50%;
        box-sizing: border-box;
        pointer-events: none;
        animation: pulsate 3s linear infinite;
      }
      /* Chat内のボタン*/
      .button {
        background-color: white;
        border-color: rgba(144, 144, 144, 0.3);
        color: #444 !important;
        border-radius: 4px;
        border-style: solid;
        border-width: 1px;
        cursor: pointer;
        height: 1.5em;
        letter-spacing: 0.07em;
        line-height: 3em;
        font-weight: 400;
        overflow: hidden;
        padding: 3px 1em 3px 1em;
        margin-left: 1em;
        text-align: center;
        text-decoration: none;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-size: 0.8em;
      }

      /* ボタンの波紋が広がっていくアニメーション*/
      @keyframes pulsate {
        0% {
          /* transform: scale(1); */
          transform: perspective(100px) translateZ(0px);
          opacity: 1;
        }
        50% {
          /* transform: scale(2); */
          transform: perspective(100px) translateZ(35px);
          opacity: 0;
        }
        100% {
          /* transform: scale(2); */
          transform: perspective(100px) translateZ(35px);
          opacity: 0;
        }
      }
      .mocchiri {
        animation: mocchiri 3s infinite;
      }
      @keyframes mocchiri {
        0% {
          transform: scale(1, 0.8);
        }
        20% {
          transform: scale(0.8, 1.1);
        }
        95% {
          transform: scale(1, 1);
        }
        100% {
          transform: scale(1, 0.8);
        }
      }
      .bururi {
        animation: bururi 1s infinite;
      }
      @keyframes bururi {
        50% {
          transform: scale(1, 1);
        }
        52% {
          transform: scale(0.96, 0.9);
        }
        54% {
          transform: scale(1, 1);
        }
        56% {
          transform: scale(0.96, 0.9);
        }
        58% {
          transform: scale(1, 1);
        }
        60% {
          transform: scale(0.96, 0.9);
        }
      }

      .patsun {
        animation: patsun 2s infinite;
      }
      @keyframes patsun {
        0% {
          transform: rotateZ(0deg);
        }
        22% {
          transform: rotateZ(0deg);
        }
        24% {
          transform: translate(-2px, -10px) rotateZ(-18deg) scale(0.8, 1.3);
        }
        26% {
          transform: rotateZ(0deg) scale(1, 1.1);
        }
        28% {
          transform: translate(0px, -2px) rotateZ(-2deg);
        }
        30% {
          transform: rotateZ(0deg);
        }
        32% {
          transform: translate(0px, -2px) rotateZ(-2deg);
        }
        33% {
          transform: rotateZ(0deg);
        }
        34% {
          transform: translate(0px, -2px) rotateZ(-2deg);
        }
        35% {
          transform: rotateZ(0deg);
        }
        36% {
          transform: translate(0px, -2px) rotateZ(-2deg);
        }
        37% {
          transform: rotateZ(0deg);
        }
        38% {
          transform: translate(0px, -2px) rotateZ(-2deg);
        }
        39% {
          transform: rotateZ(0deg);
        }
        100% {
          transform: rotateZ(0deg);
        }
      }

      /* .pulse-shadow {
          animation: pulse-shadow-primary 2s linear infinite;
      }
      @keyframes pulse-shadow-primary {
          0% {
              box-shadow: 0 0 0 0 var(--bg-color);
          }
          40% {
              box-shadow: 0 0 0 25px rgba(0, 124, 181, 0);
          }
          80% {
              box-shadow: 0 0 0 25px rgba(0, 124, 181, 0);
          }
          100% {
              box-shadow: 0 0 0 0 rgba(0, 124, 181, 0);
          }
      }     */
    </style>
  </head>
  <body>
    <v-app>
      <div id="app">
        <template v-if="app=='button'&&(contact[0].status||admin==='admin')">
          <!-- <v-btn
          v-show="contact[0].button||admin==='admin'"
          @click="go_zoom()"
          :style="style"
        >
          <v-icon x-large>{{siteSetting.icon}}</v-icon>
        </v-btn> -->
          <!-- <div
          v-show="contact[0].button||admin==='admin'"
          style="display: block; height: 10px"
        ></div> -->
          <!-- <v-btn v-show="!contact[0].button||contact[0].chat||admin==='admin'" :disabled="!contact[0].chat&&admin!=='admin'" @click="style_chat()" :style="style"> -->
          <v-btn
            :disabled="!contact[0].chat&&admin!=='admin'"
            @click="style_chat()"
            :style="style"
            :class="contact[0].chat&&contact[0].action=='pulse'?'pulse-btn yureru-js':contact[0].chat&&contact[0].action=='move'?'mocchiri':contact[0].chat&&contact[0].action=='shake'?'bururi':contact[0].chat&&contact[0].action=='jump'?'patsun':''"
          >
            <v-icon x-large>{{siteSetting.icon}}</v-icon>
          </v-btn>
        </template>
        <template v-if="app=='chat'">
          <v-container style="padding: 0; background-color: #fff">
            <v-row
              :style="'margin: 0 ;background-color: ' + siteSetting.bgColor"
              class="chat-messagae"
            >
              <v-spacer></v-spacer>
              <span :style="'font-size: 1em;color:' + siteSetting.fontColor"
                >{{contact[0].name||'Online Chat'}}</span
              >
              <v-spacer></v-spacer>
              <v-btn
                :color="siteSetting.fontColor"
                v-show="contact[0].button"
                @click="go_zoom()"
                class="yureru-js"
              >
                <span
                  :style="'text-transform: none;font-weight:600;font-size: 1.5em;color:' + siteSetting.bgColor"
                  >Live</span
                >
                <v-icon x-large :style="'color: ' + siteSetting.bgColor"
                  >mdi-video-box</v-icon
                >
                <!-- <svg
                  xmlns="http://www.w3.org/2000/svg"
                  preserveAspectRatio="none"
                  style="cursor: pointer"
                  viewBox="-25 0 75 75"
                  height="40"
                  >
                  <circle cx="10" cy="40" r="30" :fill="siteSetting.bgColor" />
                  <circle cx="10" cy="40" r="22" :fill="siteSetting.fontColor" />
                  <polygon points="0,26 0,54 27,40" :fill="siteSetting.bgColor" />
                </svg> -->
              </v-btn>
              <v-icon
                :style="'margin:0 0.2rem;color:' + siteSetting.fontColor"
                width="40px"
                v-show="!contact[0].button"
                @click="dialog1 = true"
                >mdi-translate
              </v-icon>
              <v-icon
                :color="siteSetting.fontColor"
                width="40px"
                v-show="!contact[0].button&&mic"
                @click="textToSpeech('音声サービスを開始します');startRecognition();mic=false;"
                >mdi-headset-off
              </v-icon>
              <v-icon
                :color="siteSetting.fontColor"
                width="40px"
                v-show="!contact[0].button&&!mic"
                @click="stopRecognition();mic=true;"
                >mdi-headset
              </v-icon>
              <v-icon
                :style="'margin:0 0.8rem;color:' + siteSetting.fontColor"
                @click="app='button'
              scope = 'site'
              connect_site()
              style_init()
              style_change()
              stopRecognition();mic=true;
              sending = false;
              "
                >mdi-close</v-icon
              ></v-row
            >
            <section
              ref="chatArea"
              class="chat-area"
              :style="'background-color:rgba(240,240,240,0.5);width:' + chatWidth + ';'"
            >
              <div
                class="message"
                style="margin-bottom: 0.5em; color: #333"
                v-if="contact[0].ad"
              >
                <span v-html="ad()"></span>
              </div>
              <p
                v-for="message in messages"
                :style="message.author === 'you' ? 'background-color: ' + siteSetting.bgColor + ';color: ' + siteSetting.fontColor : false"
                :class="{ 'message message-out': message.author === 'you', 'message message-in': message.author === 'me' }"
              >
                <span v-html="markp(message.body)"></span>
                <!-- {{ message.body }} -->
              </p>
            </section>
            <v-row style="margin: 0" class="chat-messagae">
              <input
                type="text"
                name=""
                placeholder="Type your message"
                v-model="youMessage"
                style="
                  outline: none;
                  background-color: #fff;
                  padding: 0 1.5rem;
                  width: calc(100% - 40px);
                "
                @keyup.enter="sendMessage('out')"
              />
              <v-icon width="40px" x-large @click="sendMessage('out')"
                >mdi-send</v-icon
              >
            </v-row>
            <!-- <v-text-field
            class="chat-messagae"
            autofocus
            label="Type your message"
            v-model="youMessage"
            dense
            clearable
            @keyup.enter="sendMessage('out')"
            style="background-color: orange"
          ></v-text-field> -->
          </v-container>
        </template>
        <template v-if="app=='chat' && dialog1">
          <v-card
            style="
              position: fixed;
              margin: 80px 20px;
              left: 0;
              top: 0;
              width: calc(100dvw - 40px);
              height: calc(100dvh - 160px);
            "
          >
            <v-container style="position: relative; width: 100%; height: 100%">
              <v-card-title class="text-h6 pa-4"> Voice </v-card-title>
              <v-combobox
                v-model="lang"
                solo
                :items="langItems"
                item-text="display"
                item-value="value"
                @change="changeVoice()"
              ></v-combobox>
              <v-autocomplete
                v-model="voice"
                solo
                :items="filterVoiceItems"
              ></v-autocomplete>
              <v-btn
                class="mx-6"
                :color="siteSetting.bgColor"
                :style="'positon:absolute;bottom:0;width:100%;color:' + siteSetting.fontColor"
                large
                @click="dialog1 = false"
                >OK</v-btn
              >
            </v-container>
          </v-card>
        </template>
        <template v-if="app=='chat' && dialog2">
          <v-card
            style="
              position: fixed;
              margin: 80px 20px;
              left: 0;
              top: 0;
              width: calc(100dvw - 40px);
              height: calc(100dvh - 160px);
            "
          >
            <v-container style="position: relative; width: 100%; height: 100%">
              <v-card-title class="text-h6"> Voice </v-card-title>
              <v-combobox
                v-model="lang"
                solo
                :items="langItems"
                item-text="display"
                item-value="value"
                @change="changeVoice()"
              ></v-combobox>
              <v-autocomplete
                v-model="voice"
                solo
                :items="filterVoiceItems"
              ></v-autocomplete>
              <v-card-text> {{youMessage}} </v-card-text>
              <v-card-text> {{dialogMessage}} </v-card-text>
              <v-container style="position: absolute; bottom: 0">
                <v-btn
                  :color="siteSetting.bgColor"
                  :style="'color:' + siteSetting.fontColor"
                  large
                  @click="textToSpeech(dialogMessage);dialog1 = false"
                  >OK</v-btn
                >
              </v-container>
            </v-container>
          </v-card>
        </template>
      </div>
    </v-app>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
    <script src="https://unpkg.com/axios@1.0.0/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/3.1.7/signalr.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.3/lz-string.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@3.0.7/marked.min.js"></script>
    <script src="microsoft.cognitiveservices.speech.sdk.bundle.js"></script>

    <script type="module">
      import ad from "https://kllc.github.io/repo/script/livelpad.js";

      // const apiBaseUrl = 'http://localhost:7071'
      const apiBaseUrl = "https://live-ec.azurewebsites.net";

      const liveApi = axios.create({
        baseURL: apiBaseUrl + "/api/",
        headers: {
          "Content-Type": "application/json",
        },
      });

      const searchParams = new URLSearchParams(window.location.search);
      self.app = new Vue({
        el: "#app",
        vuetify: new Vuetify(),
        data() {
          return {
            app: "button",
            // status: false,
            scope: "site",
            style:
              "width: 100px; height: 100px; font-size: 40px; color: white; background-color: white;",
            siteKey: "",
            userId: "",
            jschat: "",
            mic: true,
            apiKey: "",
            region: "",
            SpeechSDK: window.SpeechSDK,
            recognizer: null,
            synthesizer: null,
            speaking: false,
            sending: false,
            player: false,
            filterVoiceItems: [],
            pitch: 1,
            voice: "ja-JP-NanamiNeural",
            rate: 1.2,
            lang: { display: "日本語 (日本)", value: "ja-JP" },
            langItems: [
              { display: "日本語（日本）", value: "ja-JP" },
              { display: "English (United States)", value: "en-US" },
              { display: "简体中文（中国大陆）", value: "zh-CN" },
              { display: "한국어 (대한민국)", value: "ko-KR" },
              { display: "English (United Kingdom)", value: "en-GB" },
              { display: "English (Canada)", value: "en-CA" },
              { display: "English (Australia)", value: "en-AU" },
              { display: "English (Hong Kong)", value: "en-HK" },
              { display: "English (Ireland)", value: "en-IE" },
              { display: "English (India)", value: "en-IN" },
              { display: "English (Kenya)", value: "en-KE" },
              { display: "English (Nigeria)", value: "en-NG" },
              { display: "English (New Zealand)", value: "en-NZ" },
              { display: "English (Philippines)", value: "en-PH" },
              { display: "English (Singapore)", value: "en-SG" },
              { display: "English (Tanzania)", value: "en-TZ" },
              { display: "English (South Africa)", value: "en-ZA" },
              { display: "吴语（中国大陆）", value: "wuu-CN" },
              { display: "粤语（中国大陆）", value: "yue-CN" },
              { display: "河南方言（中国大陆）", value: "zh-CN-henan" },
              { display: "辽宁方言（中国大陆）", value: "zh-CN-liaoning" },
              { display: "陕西方言（中国大陆）", value: "zh-CN-shaanxi" },
              { display: "山东方言（中国大陆）", value: "zh-CN-shandong" },
              { display: "四川方言（中国大陆）", value: "zh-CN-sichuan" },
              { display: "中文（香港）", value: "zh-HK" },
              { display: "中文（台灣）", value: "zh-TW" },
              { display: "Afrikaans (South Africa)", value: "af-ZA" },
              { display: "Amharic (Ethiopia)", value: "am-ET" },
              { display: "Arabic (United Arab Emirates)", value: "ar-AE" },
              { display: "Arabic (Bahrain)", value: "ar-BH" },
              { display: "Arabic (Algeria)", value: "ar-DZ" },
              { display: "Arabic (Egypt)", value: "ar-EG" },
              { display: "Arabic (Iraq)", value: "ar-IQ" },
              { display: "Arabic (Jordan)", value: "ar-JO" },
              { display: "Arabic (Kuwait)", value: "ar-KW" },
              { display: "Arabic (Lebanon)", value: "ar-LB" },
              { display: "Arabic (Libya)", value: "ar-LY" },
              { display: "Arabic (Morocco)", value: "ar-MA" },
              { display: "Arabic (Oman)", value: "ar-OM" },
              { display: "Arabic (Qatar)", value: "ar-QA" },
              { display: "Arabic (Saudi Arabia)", value: "ar-SA" },
              { display: "Arabic (Syria)", value: "ar-SY" },
              { display: "Arabic (Tunisia)", value: "ar-TN" },
              { display: "Arabic (Yemen)", value: "ar-YE" },
              { display: "Azerbaijani (Latin, Azerbaijan)", value: "az-AZ" },
              { display: "Bulgarian (Bulgaria)", value: "bg-BG" },
              { display: "Bengali (Bangladesh)", value: "bn-BD" },
              { display: "Bengali (India)", value: "bn-IN" },
              { display: "Bosnian (Bosnia and Herzegovina)", value: "bs-BA" },
              { display: "Catalan (Spain)", value: "ca-ES" },
              { display: "Czech (Czechia)", value: "cs-CZ" },
              { display: "Welsh (United Kingdom)", value: "cy-GB" },
              { display: "Danish (Denmark)", value: "da-DK" },
              { display: "German (Austria)", value: "de-AT" },
              { display: "German (Switzerland)", value: "de-CH" },
              { display: "German (Germany)", value: "de-DE" },
              { display: "Greek (Greece)", value: "el-GR" },
              { display: "Spanish (Argentina)", value: "es-AR" },
              { display: "Spanish (Bolivia)", value: "es-BO" },
              { display: "Spanish (Chile)", value: "es-CL" },
              { display: "Spanish (Colombia)", value: "es-CO" },
              { display: "Spanish (Costa Rica)", value: "es-CR" },
              { display: "Spanish (Cuba)", value: "es-CU" },
              { display: "Spanish (Dominican Republic)", value: "es-DO" },
              { display: "Spanish (Ecuador)", value: "es-EC" },
              { display: "Spanish (Spain)", value: "es-ES" },
              { display: "Spanish (Equatorial Guinea)", value: "es-GQ" },
              { display: "Spanish (Guatemala)", value: "es-GT" },
              { display: "Spanish (Honduras)", value: "es-HN" },
              { display: "Spanish (Mexico)", value: "es-MX" },
              { display: "Spanish (Nicaragua)", value: "es-NI" },
              { display: "Spanish (Panama)", value: "es-PA" },
              { display: "Spanish (Peru)", value: "es-PE" },
              { display: "Spanish (Puerto Rico)", value: "es-PR" },
              { display: "Spanish (Paraguay)", value: "es-PY" },
              { display: "Spanish (El Salvador)", value: "es-SV" },
              { display: "Spanish (United States)", value: "es-US" },
              { display: "Spanish (Uruguay)", value: "es-UY" },
              { display: "Spanish (Venezuela)", value: "es-VE" },
              { display: "Estonian (Estonia)", value: "et-EE" },
              { display: "Basque (Spain)", value: "eu-ES" },
              { display: "Persian (Iran)", value: "fa-IR" },
              { display: "Finnish (Finland)", value: "fi-FI" },
              { display: "Filipino (Philippines)", value: "fil-PH" },
              { display: "French (Belgium)", value: "fr-BE" },
              { display: "French (Canada)", value: "fr-CA" },
              { display: "French (Switzerland)", value: "fr-CH" },
              { display: "French (France)", value: "fr-FR" },
              { display: "Irish (Ireland)", value: "ga-IE" },
              { display: "Galician (Spain)", value: "gl-ES" },
              { display: "Gujarati (India)", value: "gu-IN" },
              { display: "Hebrew (Israel)", value: "he-IL" },
              { display: "Hindi (India)", value: "hi-IN" },
              { display: "Croatian (Croatia)", value: "hr-HR" },
              { display: "Hungarian (Hungary)", value: "hu-HU" },
              { display: "Armenian (Armenia)", value: "hy-AM" },
              { display: "Indonesian (Indonesia)", value: "id-ID" },
              { display: "Icelandic (Iceland)", value: "is-IS" },
              { display: "Italian (Italy)", value: "it-IT" },
              { display: "Javanese (Latin, Indonesia)", value: "jv-ID" },
              { display: "Georgian (Georgia)", value: "ka-GE" },
              { display: "Kazakh (Kazakhstan)", value: "kk-KZ" },
              { display: "Khmer (Cambodia)", value: "km-KH" },
              { display: "Kannada (India)", value: "kn-IN" },
              { display: "Lao (Laos)", value: "lo-LA" },
              { display: "Lithuanian (Lithuania)", value: "lt-LT" },
              { display: "Latvian (Latvia)", value: "lv-LV" },
              { display: "Macedonian (North Macedonia)", value: "mk-MK" },
              { display: "Malayalam (India)", value: "ml-IN" },
              { display: "Mongolian (Mongolia)", value: "mn-MN" },
              { display: "Marathi (India)", value: "mr-IN" },
              { display: "Malay (Malaysia)", value: "ms-MY" },
              { display: "Maltese (Malta)", value: "mt-MT" },
              { display: "Burmese (Myanmar)", value: "my-MM" },
              { display: "Norwegian Bokmål (Norway)", value: "nb-NO" },
              { display: "Nepali (Nepal)", value: "ne-NP" },
              { display: "Dutch (Belgium)", value: "nl-BE" },
              { display: "Dutch (Netherlands)", value: "nl-NL" },
              { display: "Polish (Poland)", value: "pl-PL" },
              { display: "Pashto (Afghanistan)", value: "ps-AF" },
              { display: "Portuguese (Brazil)", value: "pt-BR" },
              { display: "Portuguese (Portugal)", value: "pt-PT" },
              { display: "Romanian (Romania)", value: "ro-RO" },
              { display: "Russian (Russia)", value: "ru-RU" },
              { display: "Sinhala (Sri Lanka)", value: "si-LK" },
              { display: "Slovak (Slovakia)", value: "sk-SK" },
              { display: "Slovenian (Slovenia)", value: "sl-SI" },
              { display: "Somali (Somalia)", value: "so-SO" },
              { display: "Albanian (Albania)", value: "sq-AL" },
              { display: "Serbian (Cyrillic, Serbia)", value: "sr-RS" },
              { display: "Sundanese (Indonesia)", value: "su-ID" },
              { display: "Swedish (Sweden)", value: "sv-SE" },
              { display: "Swahili (Kenya)", value: "sw-KE" },
              { display: "Swahili (Tanzania)", value: "sw-TZ" },
              { display: "Tamil (India)", value: "ta-IN" },
              { display: "Tamil (Sri Lanka)", value: "ta-LK" },
              { display: "Tamil (Malaysia)", value: "ta-MY" },
              { display: "Tamil (Singapore)", value: "ta-SG" },
              { display: "Telugu (India)", value: "te-IN" },
              { display: "Thai (Thailand)", value: "th-TH" },
              { display: "Turkish (Turkey)", value: "tr-TR" },
              { display: "Ukrainian (Ukraine)", value: "uk-UA" },
              { display: "Urdu (India)", value: "ur-IN" },
              { display: "Urdu (Pakistan)", value: "ur-PK" },
              { display: "Uzbek (Latin, Uzbekistan)", value: "uz-UZ" },
              { display: "Vietnamese (Vietnam)", value: "vi-VN" },
              { display: "Zulu (South Africa)", value: "zu-ZA" },
            ],
            voiceItems: [
              "ja-JP-NanamiNeural",
              "ja-JP-KeitaNeural",
              "ja-JP-AoiNeural",
              "ja-JP-DaichiNeural",
              "ja-JP-MayuNeural",
              "ja-JP-NaokiNeural",
              "ja-JP-ShioriNeural",
              "en-US-AIGenerate1Neural",
              "en-US-AIGenerate2Neural",
              "en-US-AmberNeural",
              "en-US-AnaNeural",
              "en-US-AriaNeural",
              "en-US-AshleyNeural",
              "en-US-BrandonNeural",
              "en-US-ChristopherNeural",
              "en-US-CoraNeural",
              "en-US-DavisNeural",
              "en-US-ElizabethNeural",
              "en-US-EricNeural",
              "en-US-GuyNeural",
              "en-US-JacobNeural",
              "en-US-JaneNeural",
              "en-US-JasonNeural",
              "en-US-JennyMultilingualNeural",
              "en-US-JennyNeural",
              "en-US-MichelleNeural",
              "en-US-MonicaNeural",
              "en-US-NancyNeural",
              "en-US-RogerNeural",
              "en-US-SaraNeural",
              "en-US-TonyNeural",
              "zh-CN-XiaochenNeural",
              "zh-CN-XiaohanNeural",
              "zh-CN-XiaomengNeural",
              "zh-CN-XiaomoNeural",
              "zh-CN-XiaoqiuNeural",
              "zh-CN-XiaoruiNeural",
              "zh-CN-XiaoshuangNeural",
              "zh-CN-XiaoxiaoNeural",
              "zh-CN-XiaoxuanNeural",
              "zh-CN-XiaoyanNeural",
              "zh-CN-XiaoyiNeural",
              "zh-CN-XiaoyouNeural",
              "zh-CN-XiaozhenNeural",
              "zh-CN-YunfengNeural",
              "zh-CN-YunhaoNeural",
              "zh-CN-YunjianNeural",
              "zh-CN-YunxiaNeural",
              "zh-CN-YunxiNeural",
              "zh-CN-YunyangNeural",
              "zh-CN-YunyeNeural",
              "zh-CN-YunzeNeural",
              "zh-CN-henan-YundengNeural",
              "zh-CN-liaoning-XiaobeiNeural",
              "zh-CN-shaanxi-XiaoniNeural",
              "zh-CN-shandong-YunxiangNeural",
              "zh-CN-sichuan-YunxiNeural",
              "af-ZA-AdriNeural",
              "af-ZA-WillemNeural",
              "am-ET-AmehaNeural",
              "am-ET-MekdesNeural",
              "ar-AE-FatimaNeural",
              "ar-AE-HamdanNeural",
              "ar-BH-AliNeural",
              "ar-BH-LailaNeural",
              "ar-DZ-AminaNeural",
              "ar-DZ-IsmaelNeural",
              "ar-EG-SalmaNeural",
              "ar-EG-ShakirNeural",
              "ar-IQ-BasselNeural",
              "ar-IQ-RanaNeural",
              "ar-JO-SanaNeural",
              "ar-JO-TaimNeural",
              "ar-KW-FahedNeural",
              "ar-KW-NouraNeural",
              "ar-LB-LaylaNeural",
              "ar-LB-RamiNeural",
              "ar-LY-ImanNeural",
              "ar-LY-OmarNeural",
              "ar-MA-JamalNeural",
              "ar-MA-MounaNeural",
              "ar-OM-AbdullahNeural",
              "ar-OM-AyshaNeural",
              "ar-QA-AmalNeural",
              "ar-QA-MoazNeural",
              "ar-SA-HamedNeural",
              "ar-SA-ZariyahNeural",
              "ar-SY-AmanyNeural",
              "ar-SY-LaithNeural",
              "ar-TN-HediNeural",
              "ar-TN-ReemNeural",
              "ar-YE-MaryamNeural",
              "ar-YE-SalehNeural",
              "az-AZ-BabekNeural",
              "az-AZ-BanuNeural",
              "bg-BG-BorislavNeural",
              "bg-BG-KalinaNeural",
              "bn-BD-NabanitaNeural",
              "bn-BD-PradeepNeural",
              "bn-IN-BashkarNeural",
              "bn-IN-TanishaaNeural",
              "bs-BA-GoranNeural",
              "bs-BA-VesnaNeural",
              "ca-ES-AlbaNeural",
              "ca-ES-EnricNeural",
              "ca-ES-JoanaNeural",
              "cs-CZ-AntoninNeural",
              "cs-CZ-VlastaNeural",
              "cy-GB-AledNeural",
              "cy-GB-NiaNeural",
              "da-DK-ChristelNeural",
              "da-DK-JeppeNeural",
              "de-AT-IngridNeural",
              "de-AT-JonasNeural",
              "de-CH-JanNeural",
              "de-CH-LeniNeural",
              "de-DE-AmalaNeural",
              "de-DE-BerndNeural",
              "de-DE-ChristophNeural",
              "de-DE-ConradNeural",
              "de-DE-ElkeNeural",
              "de-DE-GiselaNeural",
              "de-DE-KasperNeural",
              "de-DE-KatjaNeural",
              "de-DE-KillianNeural",
              "de-DE-KlarissaNeural",
              "de-DE-KlausNeural",
              "de-DE-LouisaNeural",
              "de-DE-MajaNeural",
              "de-DE-RalfNeural",
              "de-DE-TanjaNeural",
              "el-GR-AthinaNeural",
              "el-GR-NestorasNeural",
              "en-AU-NatashaNeural",
              "en-AU-WilliamNeural",
              "en-CA-ClaraNeural",
              "en-CA-LiamNeural",
              "en-GB-AbbiNeural",
              "en-GB-AlfieNeural",
              "en-GB-BellaNeural",
              "en-GB-ElliotNeural",
              "en-GB-EthanNeural",
              "en-GB-HollieNeural",
              "en-GB-LibbyNeural",
              "en-GB-MaisieNeural",
              "en-GB-NoahNeural",
              "en-GB-OliverNeural",
              "en-GB-OliviaNeural",
              "en-GB-RyanNeural",
              "en-GB-SoniaNeural",
              "en-GB-ThomasNeural",
              "en-HK-SamNeural",
              "en-HK-YanNeural",
              "en-IE-ConnorNeural",
              "en-IE-EmilyNeural",
              "en-IN-NeerjaNeural",
              "en-IN-PrabhatNeural",
              "en-KE-AsiliaNeural",
              "en-KE-ChilembaNeural",
              "en-NG-AbeoNeural",
              "en-NG-EzinneNeural",
              "en-NZ-MitchellNeural",
              "en-NZ-MollyNeural",
              "en-PH-JamesNeural",
              "en-PH-RosaNeural",
              "en-SG-LunaNeural",
              "en-SG-WayneNeural",
              "en-TZ-ElimuNeural",
              "en-TZ-ImaniNeural",
              "en-ZA-LeahNeural",
              "en-ZA-LukeNeural",
              "es-AR-ElenaNeural",
              "es-AR-TomasNeural",
              "es-BO-MarceloNeural",
              "es-BO-SofiaNeural",
              "es-CL-CatalinaNeural",
              "es-CL-LorenzoNeural",
              "es-CO-GonzaloNeural",
              "es-CO-SalomeNeural",
              "es-CR-JuanNeural",
              "es-CR-MariaNeural",
              "es-CU-BelkysNeural",
              "es-CU-ManuelNeural",
              "es-DO-EmilioNeural",
              "es-DO-RamonaNeural",
              "es-EC-AndreaNeural",
              "es-EC-LuisNeural",
              "es-ES-AlvaroNeural",
              "es-ES-ElviraNeural",
              "es-GQ-JavierNeural",
              "es-GQ-TeresaNeural",
              "es-GT-AndresNeural",
              "es-GT-MartaNeural",
              "es-HN-CarlosNeural",
              "es-HN-KarlaNeural",
              "es-MX-BeatrizNeural",
              "es-MX-CandelaNeural",
              "es-MX-CarlotaNeural",
              "es-MX-CecilioNeural",
              "es-MX-DaliaNeural",
              "es-MX-GerardoNeural",
              "es-MX-JorgeNeural",
              "es-MX-LarissaNeural",
              "es-MX-LibertoNeural",
              "es-MX-LucianoNeural",
              "es-MX-MarinaNeural",
              "es-MX-NuriaNeural",
              "es-MX-PelayoNeural",
              "es-MX-RenataNeural",
              "es-MX-YagoNeural",
              "es-NI-FedericoNeural",
              "es-NI-YolandaNeural",
              "es-PA-MargaritaNeural",
              "es-PA-RobertoNeural",
              "es-PE-AlexNeural",
              "es-PE-CamilaNeural",
              "es-PR-KarinaNeural",
              "es-PR-VictorNeural",
              "es-PY-MarioNeural",
              "es-PY-TaniaNeural",
              "es-SV-LorenaNeural",
              "es-SV-RodrigoNeural",
              "es-US-AlonsoNeural",
              "es-US-PalomaNeural",
              "es-UY-MateoNeural",
              "es-UY-ValentinaNeural",
              "es-VE-PaolaNeural",
              "es-VE-SebastianNeural",
              "et-EE-AnuNeural",
              "et-EE-KertNeural",
              "fa-IR-DilaraNeural",
              "fa-IR-FaridNeural",
              "fi-FI-HarriNeural",
              "fi-FI-NooraNeural",
              "fi-FI-SelmaNeural",
              "fil-PH-AngeloNeural",
              "fil-PH-BlessicaNeural",
              "fr-BE-CharlineNeural",
              "fr-BE-GerardNeural",
              "fr-CA-AntoineNeural",
              "fr-CA-JeanNeural",
              "fr-CA-SylvieNeural",
              "fr-CH-ArianeNeural",
              "fr-CH-FabriceNeural",
              "fr-FR-AlainNeural",
              "fr-FR-BrigitteNeural",
              "fr-FR-CelesteNeural",
              "fr-FR-ClaudeNeural",
              "fr-FR-CoralieNeural",
              "fr-FR-DeniseNeural",
              "fr-FR-EloiseNeural",
              "fr-FR-HenriNeural",
              "fr-FR-JacquelineNeural",
              "fr-FR-JeromeNeural",
              "fr-FR-JosephineNeural",
              "fr-FR-MauriceNeural",
              "fr-FR-YvesNeural",
              "fr-FR-YvetteNeural",
              "ga-IE-ColmNeural",
              "ga-IE-OrlaNeural",
              "gl-ES-RoiNeural",
              "gl-ES-SabelaNeural",
              "gu-IN-DhwaniNeural",
              "gu-IN-NiranjanNeural",
              "he-IL-AvriNeural",
              "he-IL-HilaNeural",
              "hi-IN-MadhurNeural",
              "hi-IN-SwaraNeural",
              "hr-HR-GabrijelaNeural",
              "hr-HR-SreckoNeural",
              "hu-HU-NoemiNeural",
              "hu-HU-TamasNeural",
              "id-ID-ArdiNeural",
              "id-ID-GadisNeural",
              "is-IS-GudrunNeural",
              "is-IS-GunnarNeural",
              "it-IT-BenignoNeural",
              "it-IT-CalimeroNeural",
              "it-IT-CataldoNeural",
              "it-IT-DiegoNeural",
              "it-IT-ElsaNeural",
              "it-IT-FabiolaNeural",
              "it-IT-FiammaNeural",
              "it-IT-GianniNeural",
              "it-IT-ImeldaNeural",
              "it-IT-IrmaNeural",
              "it-IT-IsabellaNeural",
              "it-IT-LisandroNeural",
              "it-IT-PalmiraNeural",
              "it-IT-PierinaNeural",
              "it-IT-RinaldoNeural",
              "ja-JP-KeitaNeural",
              "ja-JP-NanamiNeural",
              "jv-ID-DimasNeural",
              "jv-ID-SitiNeural",
              "ka-GE-EkaNeural",
              "ka-GE-GiorgiNeural",
              "kk-KZ-AigulNeural",
              "kk-KZ-DauletNeural",
              "km-KH-PisethNeural",
              "km-KH-SreymomNeural",
              "kn-IN-GaganNeural",
              "kn-IN-SapnaNeural",
              "ko-KR-InJoonNeural",
              "ko-KR-SunHiNeural",
              "lo-LA-ChanthavongNeural",
              "lo-LA-KeomanyNeural",
              "lt-LT-LeonasNeural",
              "lt-LT-OnaNeural",
              "lv-LV-EveritaNeural",
              "lv-LV-NilsNeural",
              "mk-MK-AleksandarNeural",
              "mk-MK-MarijaNeural",
              "ml-IN-MidhunNeural",
              "ml-IN-SobhanaNeural",
              "mn-MN-BataaNeural",
              "mn-MN-YesuiNeural",
              "mr-IN-AarohiNeural",
              "mr-IN-ManoharNeural",
              "ms-MY-OsmanNeural",
              "ms-MY-YasminNeural",
              "mt-MT-GraceNeural",
              "mt-MT-JosephNeural",
              "my-MM-NilarNeural",
              "my-MM-ThihaNeural",
              "nb-NO-FinnNeural",
              "nb-NO-IselinNeural",
              "nb-NO-PernilleNeural",
              "ne-NP-HemkalaNeural",
              "ne-NP-SagarNeural",
              "nl-BE-ArnaudNeural",
              "nl-BE-DenaNeural",
              "nl-NL-ColetteNeural",
              "nl-NL-FennaNeural",
              "nl-NL-MaartenNeural",
              "pl-PL-AgnieszkaNeural",
              "pl-PL-MarekNeural",
              "pl-PL-ZofiaNeural",
              "ps-AF-GulNawazNeural",
              "ps-AF-LatifaNeural",
              "pt-BR-AntonioNeural",
              "pt-BR-BrendaNeural",
              "pt-BR-DonatoNeural",
              "pt-BR-ElzaNeural",
              "pt-BR-FabioNeural",
              "pt-BR-FranciscaNeural",
              "pt-BR-GiovannaNeural",
              "pt-BR-HumbertoNeural",
              "pt-BR-JulioNeural",
              "pt-BR-LeilaNeural",
              "pt-BR-LeticiaNeural",
              "pt-BR-ManuelaNeural",
              "pt-BR-NicolauNeural",
              "pt-BR-ValerioNeural",
              "pt-BR-YaraNeural",
              "pt-PT-DuarteNeural",
              "pt-PT-FernandaNeural",
              "pt-PT-RaquelNeural",
              "ro-RO-AlinaNeural",
              "ro-RO-EmilNeural",
              "ru-RU-DariyaNeural",
              "ru-RU-DmitryNeural",
              "ru-RU-SvetlanaNeural",
              "si-LK-SameeraNeural",
              "si-LK-ThiliniNeural",
              "sk-SK-LukasNeural",
              "sk-SK-ViktoriaNeural",
              "sl-SI-PetraNeural",
              "sl-SI-RokNeural",
              "so-SO-MuuseNeural",
              "so-SO-UbaxNeural",
              "sq-AL-AnilaNeural",
              "sq-AL-IlirNeural",
              "sr-RS-NicholasNeural",
              "sr-RS-SophieNeural",
              "su-ID-JajangNeural",
              "su-ID-TutiNeural",
              "sv-SE-HilleviNeural",
              "sv-SE-MattiasNeural",
              "sv-SE-SofieNeural",
              "sw-KE-RafikiNeural",
              "sw-KE-ZuriNeural",
              "sw-TZ-DaudiNeural",
              "sw-TZ-RehemaNeural",
              "ta-IN-PallaviNeural",
              "ta-IN-ValluvarNeural",
              "ta-LK-KumarNeural",
              "ta-LK-SaranyaNeural",
              "ta-MY-KaniNeural",
              "ta-MY-SuryaNeural",
              "ta-SG-AnbuNeural",
              "ta-SG-VenbaNeural",
              "te-IN-MohanNeural",
              "te-IN-ShrutiNeural",
              "th-TH-AcharaNeural",
              "th-TH-NiwatNeural",
              "th-TH-PremwadeeNeural",
              "tr-TR-AhmetNeural",
              "tr-TR-EmelNeural",
              "uk-UA-OstapNeural",
              "uk-UA-PolinaNeural",
              "ur-IN-GulNeural",
              "ur-IN-SalmanNeural",
              "ur-PK-AsadNeural",
              "ur-PK-UzmaNeural",
              "uz-UZ-MadinaNeural",
              "uz-UZ-SardorNeural",
              "vi-VN-HoaiMyNeural",
              "vi-VN-NamMinhNeural",
              "zh-HK-HiuGaaiNeural",
              "zh-HK-HiuMaanNeural",
              "zh-HK-WanLungNeural",
              "zh-TW-HsiaoChenNeural",
              "zh-TW-HsiaoYuNeural",
              "zh-TW-YunJheNeural",
              "zu-ZA-ThandoNeural",
              "zu-ZA-ThembaNeural",
            ],
            contact: [
              {
                zoomurl: "",
                status: false,
                func: "button",
                chat: false,
                button: false,
                name: "",
                chatScore: 0,
              },
            ],
            siteSetting: {
              x: 0,
              y: 0,
              size: 0,
              name: "",
              number: 1,
              message: "",
              timeout: 60,
              response: "",
              parent: {
                init: {
                  opacity: 1,
                  right: "0px",
                  bottom: "0px",
                  width: "0px",
                  height: "0px",
                  transition: "all 1s ease",
                },
                set: {
                  right: "0px",
                  bottom: "0px",
                  width: "0px",
                  height: "0px",
                },
              },
            },
            meMessage: "",
            youMessage: "",
            messages: [
              {
                body: "Please enter any inquiry you may have.",
                author: "me",
              },
            ],
            dialogMessage: "",
            admin: searchParams.get("admin"),
            chatWidth: "600px",
            timeout: false,
            json: {
              f: "select",
              q: "お問合せ内容をお選びいただくか、ご質問内容をご入力ください。",
              a: [],
            },
            dialog1: false,
            dialog2: false,
          };
        },
        async mounted() {
          this.style =
            "width: 0px; height: 0px; font-size: 0px; color: white; background-color: white;";

          this.siteKey = searchParams.get("key");
          await this.connect_site();

          // アプリケーションの初期化時に requestAuthorizationToken を実行
          this.requestAuthorizationToken();

          // 8分 (480000ミリ秒) ごとに requestAuthorizationToken を再実行
          setInterval(() => {
            this.requestAuthorizationToken();
          }, 480000);

          this.style =
            "width: " +
            this.siteSetting.size +
            "px; height: " +
            this.siteSetting.size +
            "px; font-size: " +
            this.siteSetting.size / 2 +
            "px; border-radius:" +
            (this.siteSetting.size * this.siteSetting.br) / 100 +
            "px; color:" +
            this.siteSetting.fontColor +
            "; background-color:" +
            this.siteSetting.bgColor +
            ";";

          if (this.siteSetting.message) {
            this.messages = [
              {
                body:
                  typeof this.siteSetting.message == "object"
                    ? JSON.stringify(this.siteSetting.message)
                    : this.siteSetting.message,
                author: "me",
              },
            ];
          }

          if (this.admin) {
            this.userId = this.admin;
            this.parent();
          } else {
            this.userId = sessionStorage.getItem("userId");
            if (!this.userId) {
              this.userId = this.uuid();
              sessionStorage.setItem("userId", this.userId);
            }
          }
          await this.signalRConnect();
          // await this.add_group()

          const renderer = new marked.Renderer();
          renderer.link = (href, title, text) =>
            `<a target="_blank" href="${href}" title="${title}">${text}</a>`;
          marked.setOptions({
            renderer: renderer,
          });

          this.style_init();
          this.style_change();

          if (!this.admin) {
            this.send_message(
              { func: "mount", userId: this.userId },
              "",
              this.siteKey
            );
          }
          // メッセージ取れたら何もしない。
          if (!this.get_message()) {
            this.json_chat();
          }
          this.changeVoice();
        },
        methods: {
          ad() {
            return ad(this.contact[0].ad);
          },
          parent() {
            // 管理者甩メソッド
            window.addEventListener(
              "message",
              (event) => {
                // if (event.origin.startsWith('https://live-ec.net')) {
                this.receive(event.data);
                // }
              },
              { once: false }
            );
          },
          async signalRConnect() {
            // SingleR Connection 処理
            const connection = new signalR.HubConnectionBuilder()
              // .withUrl(apiBaseUrl + "/api")
              .withUrl(
                apiBaseUrl +
                  "/api?userId=" +
                  this.userId +
                  "&group=" +
                  this.siteKey +
                  "&isSmartPhone=" +
                  "2"
                // this.isSmartPhone()
              )
              .withAutomaticReconnect()
              .configureLogging(signalR.LogLevel.Information)
              .build();
            // if (!this.admin) {
            connection.on("newMessage", (message) => {
              // ここに message が来たときの処理を書く
              // document.getElementById("messages").innerHTML = message;
              this.receive(message);
            });

            connection.on("disconnected", function () {
              setTimeout(function () {
                connection.start();
              }, 5000);
            });

            var self = this;
            document.addEventListener("visibilitychange", function () {
              if (document.visibilityState === "visible") {
                if (connection.connectionState == 0) {
                  connection.start();
                }
                self.get_message();
              }
            });
            // }
            await connection.start().then(this.add_group).catch(console.error);
          },
          async get_message() {
            const res = await liveApi.post("get-message", {
              userId: this.userId,
              group: this.siteKey,
            });
            if (res.data && res.data.info && res.data.info.data) {
              this.messages = res.data.info.data;
              return true;
            } else {
              return false;
            }
          },
          async add_group() {
            await liveApi.post("add-group", {
              userId: this.userId,
              key: "signalr-list",
              group: this.siteKey,
            });
          },
          go_zoom() {
            if (this.admin === "admin") {
              return;
            }
            window.open(this.contact[0].zoomurl);
          },
          async connect_site() {
            const res = await liveApi.post("live-get-site", {
              key: this.siteKey,
            });
            if (!res.data.site) {
              return false;
            }
            this.siteSetting = res.data.site;
            this.contact = res.data.contact;
            return true;
          },
          async send_message(message, id, group) {
            // alert('iframe-send-' + id + group + JSON.stringify(message))
            const opt = {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                id: id,
                message: Object.assign(message, {
                  isSmartPhone: this.isSmartPhone(),
                  userAgent: navigator.userAgent,
                }),
                group: group,
                lang: this.lang.value,
                voice: !this.mic,
              }),
            };
            const res = await fetch(
              apiBaseUrl + "/api/send-message-client",
              opt
            );
          },
          async receive(data) {
            // alert('iframe-recieve-'+JSON.stringify(data))
            switch (data.func) {
              case "app":
                this.app = data.app;
                switch (data.app) {
                  case "button":
                    this.style_change();
                    break;
                  case "chat":
                    this.style_chat();
                    break;
                }
                // 実行する処理 //式が値1に当てはまる場合に実行される
                break;
              case "contact":
                if (this.scope == "site") {
                  if (this.contact.length) {
                    // 過去データを消す
                    this.contact = this.contact.filter((rec) => {
                      return rec.id != data.data.id;
                    });
                  }
                  // 最新に１行追加する
                  if (data.data.status) {
                    if (this.contact.length) {
                      this.contact.unshift(data.data);
                    } else {
                      this.contact.push(data.data);
                    }
                    this.contact = Object.assign([], this.contact);
                  }
                  this.style_change();
                  if (this.contact[0].button && !this.mic) {
                    this.stopRecognition();
                    this.mic = true;
                  }
                }
                break;
              case "contact-user":
                this.scope = "user";
                if (this.contact.length) {
                  this.contact.unshift(data.data);
                } else {
                  this.contact.push(data.data);
                }
                this.contact = Object.assign([], this.contact);
                if (this.app == "button") {
                  this.style_change();
                }
                if (this.contact[0].button && !this.mic) {
                  this.stopRecognition();
                  this.mic = true;
                }
                break;
              case "disconnect":
                await this.connect_site();
                if (this.admin) {
                  this.scope = "site";
                  this.app = "button";
                  this.style_change();
                } else if (this.app == "button") {
                  this.style_change();
                }
                break;
              case "chat":
                // 実行する処理 //式が値2に当てはまる場合に実行される
                if (this.sending) {
                  if (this.app != "chat") {
                    this.app = "chat";
                    this.style_chat();
                  }
                  this.timeout = false;

                  this.messages = data.data;
                  this.json_chat();
                }
                this.sending = false;
                // this.scrollMassage()
                // this.messages =Object.assign({},data.data)
                break;
              case "child":
                this.style = data.style;
                this.siteSetting.icon = data.icon;
                break;
              case "zoom":
                window.location.href = this.contact[0].zoomurl;
              // this.go_zoom()
              case "parent":
                let style = data.style;
                // if (this.contact[0].button && this.contact[0].chat || this.admin=='admin') {
                //   Object.assign(style, {
                //     height: style.size * 2 + 12 + 'px',
                //   })
                // } else {
                //   Object.assign(style, {
                //     height: style.size + 'px',
                //   })
                // }
                document.documentElement.style.setProperty(
                  "--border-size",
                  style.size * 0.1 + 10 + "px"
                );
                document.documentElement.style.setProperty(
                  "--bg-color",
                  style.bgColor
                );
                window.parent.postMessage(style, "*");
                break;
              case "alert":
                alert(data);
                // 実行する処理 //式が値3に当てはまる場合に実行される
                break;
              case "poling":
                this.send_message(
                  {
                    func: "chat",
                    poling: true,
                    data: this.messages,
                    userId: this.userId,
                  },
                  "",
                  this.siteKey
                );
                break;
              case "":
                // 実行する処理 //式が値3に当てはまる場合に実行される
                break;
            }
          },
          uuid() {
            var ALPHABET =
              "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";
            var ID_LENGTH = 10;
            var rtn = "";
            for (var i = 0; i < ID_LENGTH; i++) {
              rtn += ALPHABET.charAt(
                Math.floor(Math.random() * ALPHABET.length)
              );
            }
            return rtn;
          },
          style_init() {
            window.parent.postMessage(this.siteSetting.parent.init, "*");
          },
          style_change() {
            document.documentElement.style.setProperty(
              "--bg-color",
              this.siteSetting.bgColor
            );
            document.documentElement.style.setProperty(
              "--border-size",
              this.siteSetting.size * 0.1 + 10 + "px"
            );

            // 1.2.1
            if (this.admin && this.admin !== "admin") {
              Object.assign(this.siteSetting.parent.set, {
                left: null,
                right: "-30px",
                top: null,
                bottom: "-30px",
              });
            }
            window.parent.postMessage(this.siteSetting.parent.set, "*");
          },
          style_chat() {
            if (this.admin === "admin") {
              return;
            }
            let style = "";
            this.app = "chat";
            this.scope = "user";
            if (this.isSmartPhone()) {
              style = {
                width: "100vw",
                height: "100vh",
                height: "100dvh",
                bottom: "0px",
                right: "0px",
                "border-radius": "10px",
              };
              this.chatWidth = "100vw";
            } else {
              style = {
                width: "400px",
                height: "460px",
                bottom: "20px",
                right: "10px",
                "border-radius": "20px",
              };
              this.chatWidth = "400px";
            }
            this.scrollMassage();
            window.parent.postMessage(style, "*");
          },
          isSmartPhone() {
            if (navigator.userAgent.match(/iPhone|Android.+Mobile/)) {
              return true;
            } else if (
              window.matchMedia &&
              window.matchMedia("(max-device-width: 640px)").matches
            ) {
              return true;
            } else {
              return false;
            }

            // if (navigator.maxTouchPoints > 0) {
            //   return true
            // }
            // if (navigator.msMaxTouchPoints > 0) {
            //   return true
            // }
            // if (window.matchMedia('(pointer:coarse)').matches) {
            //   return true
            // }
            // if ('orientation' in window) {
            //   return true
            // }

            return false;
          },
          sendMessage(direction) {
            if (!this.youMessage && !this.meMessage) {
              return;
            }
            if (this.admin) {
              return;
            }
            if (direction === "out") {
              if (this.sending || this.speaking) return;
              this.sending = true;
              this.messages.push({ body: this.youMessage, author: "you" });
            } else if (direction === "in") {
              this.messages.push({ body: this.meMessage, author: "me" });
            } else {
              alert("something went wrong");
            }
            this.send_message(
              {
                func: "chat",
                data: this.messages,
                ai:
                  this.contact[0].chat === "ai" ||
                  this.contact[0].chat === "gpt"
                    ? this.contact[0].chatScore
                    : false,
                chat: this.contact[0].chat,
                userId: this.userId,
                direction: direction,
                groupName: this.siteKey,
                message: this.youMessage,
                jschat: this.jschat,
              },
              "",
              this.siteKey
            );
            this.youMessage = "";
            this.meMessage = "";
            this.timeout = true;

            if (this.contact[0].chat === "gpt" && this.jschat !== "jschat") {
              this.messages.push({
                body: "<img width='40' src='https://livelp.net/ten.gif' style='margin:5px 5px;'></img>",
                author: "me",
              });
              this.scrollMassage();
            } else if (this.siteSetting.timeout && this.siteSetting.response) {
              setTimeout(() => {
                if (this.timeout) {
                  this.messages.push({
                    body: this.siteSetting.response,
                    author: "me",
                  });
                  this.scrollMassage();
                }
              }, this.siteSetting.timeout * 1000);
            }
            this.jschat = "";
          },
          scrollMassage() {
            Vue.nextTick(() => {
              let messageDisplay = this.$refs.chatArea;
              try {
                messageDisplay.scrollTop = messageDisplay.scrollHeight;
              } catch {}
            });
          },
          clearAllMessages() {
            this.messages = [];
          },
          markp(string) {
            try {
              const json = JSON.parse(string);
              return marked.parse(json.q);
            } catch (error) {
              return marked.parse(string);
            }
          },
          json_chat() {
            let message = this.messages.slice(-1)[0];
            this.messages = this.messages.slice(0, -1);

            this.messages.push({
              body: "<img width='40' src='https://livelp.net/ten.gif' style='margin:5px 5px;'></img>",
              author: "me",
            });
            this.scrollMassage();

            try {
              this.json = JSON.parse(message.body);
              let self = this;
              setTimeout(function () {
                self.messages = self.messages.slice(0, -1);
                self.json_excec();
                self.scrollMassage();
              }, 1100);
            } catch (error) {
              let self = this;
              setTimeout(function () {
                self.messages = self.messages.slice(0, -1);
                self.messages.push(message);
                if (!this.mic) {
                  if (self.isSmartPhone()) {
                    self.dialogMessage = message.body;
                    self.dialog2 = true;
                  } else {
                    self.textToSpeech(message.body);
                  }
                }
                self.scrollMassage();
              }, 1100);
            }
          },
          jssend(string) {
            this.youMessage = string;
            this.jschat = "jschat";
            this.sendMessage("out");
          },
          json_excec() {
            this.messages.push({ body: this.json.q, author: "me" });
            if (this.json.f == "Choice") {
              for (let i in this.json.a) {
                let ihtml =
                  `<a class="button" onclick="app.jssend('` +
                  this.json.a[i].value +
                  `')">` +
                  this.json.a[i].value +
                  `</a>`;
                this.messages.push({ body: ihtml, author: "js" });
              }
              // this.scrollMassage()
            } else if (this.json.f == "Jump") {
              let setThis = this;
              setTimeout(
                function () {
                  window.top.location.href = setThis.json.url;
                },
                setThis.json.time ? setThis.json.time * 1000 : 5000
              );
            } else if (this.json.f == "end") {
              // 特に何もなし
            }
          },
          requestAuthorizationToken() {
            let self = this;
            var a = new XMLHttpRequest();
            a.open("GET", "https://livelp.net/tokengithub.php");
            a.setRequestHeader(
              "Content-Type",
              "application/x-www-form-urlencoded"
            );
            a.send("");
            a.onload = function () {
              var token = JSON.parse(
                window.atob(this.responseText.split(".")[1])
              );
              self.region = token.region;
              self.apiKey = this.responseText;
              console.log("Got an authorization token: " + token);
            };
          },
          startRecognition() {
            // let speechConfig = this.SpeechSDK.SpeechConfig.fromSubscription(
            let speechConfig =
              this.SpeechSDK.SpeechConfig.fromAuthorizationToken(
                this.apiKey,
                this.region
              );
            speechConfig.speechRecognitionLanguage = this.lang.value;

            let audioConfig =
              this.SpeechSDK.AudioConfig.fromDefaultMicrophoneInput();
            this.recognizer = new this.SpeechSDK.SpeechRecognizer(
              speechConfig,
              audioConfig
            );

            this.recognizer.recognizing = (s, e) => {
              console.log(`RECOGNIZING: Text=${e.result.text}`);
            };

            this.recognizer.recognized = (s, e) => {
              if (
                e.result.reason === this.SpeechSDK.ResultReason.RecognizedSpeech
              ) {
                console.log(`RECOGNIZED: Text=${e.result.text}`);
                if (!this.sending && !this.speaking) {
                  this.youMessage = e.result.text;
                  this.sendMessage("out");
                }
              } else if (
                e.result.reason === this.SpeechSDK.ResultReason.NoMatch
              ) {
                console.log("NOMATCH: Speech could not be recognized.");
              } else {
                alert(1);
              }
            };

            this.recognizer.startContinuousRecognitionAsync(
              () => {
                console.log("Recognition started");
              },
              (err) => {
                console.error("Error starting recognition: " + err);
              }
            );
          },
          stopRecognition() {
            if (!this.recognizer) return;
            this.recognizer.stopContinuousRecognitionAsync(
              () => {
                console.log("Recognition stopped");
              },
              (err) => {
                console.error("Error stopping recognition: " + err);
              }
            );
            this.stopSpeaking();
          },
          async textToSpeech(text) {
            if (this.speaking) return;
            this.speaking = true;
            // this.dialog=true;

            // if (!this.player) {
            // this.player = new this.SpeechSDK.SpeakerAudioDestination();
            // let self = this;

            // this.player.onAudioEnd = function (_) {
            //   self.speaking = false;
            // };
            // this.player.onAudioStart = function (_) {
            //   self.speaking = true;
            // };
            // } else {
            //   this.player.resume()
            // }
            // this.startSynthesizer()

            let player = new this.SpeechSDK.SpeakerAudioDestination();

            let speechConfig =
              this.SpeechSDK.SpeechConfig.fromAuthorizationToken(
                this.apiKey,
                this.region
              );

            // let audioConfig = this.SpeechSDK.AudioConfig.fromSpeakerOutput(
            //   this.player
            // );
            let audioConfig =
              this.SpeechSDK.AudioConfig.fromSpeakerOutput(player);

            // this.synthesizer = new this.SpeechSDK.SpeechSynthesizer(
            //   speechConfig,
            //   audioConfig
            // );

            let synthesizer = new this.SpeechSDK.SpeechSynthesizer(
              speechConfig,
              audioConfig
            );

            let ssml =
              `
              <speak version="1.0" xmlns="http://www.w3.org/2001/10/synthesis" xmlns:mstts="https://www.w3.org/2001/mstts" xml:lang="${
                this.lang.value
              }">
              <voice name="${this.voice}">
              <mstts:express-as style="standard">
              <prosody pitch="${(this.pitch - 1) * 100}%" rate="${this.rate}">
              ` +
              text +
              `
              </prosody>
              </mstts:express-as>
              </voice>
              </speak>
              `;
            try {
              // await synthesizer.speakTextAsync(text)
              await synthesizer.speakSsmlAsync(ssml, (result) => {
                this.speaking = false;
                synthesizer.close();
                // this.synthesizer.close(()=>{this.startSynthesizer()})
                // this.synthesizer = undefined;
                // this.synthesizer.dispose(true);
              });
            } catch (err) {
              console.error("Error synthesizing speech:", err);
              this.speaking = false;
              // this.synthesizer.pause();
              // this.synthesizer.close()
            } finally {
              // this.speaking = false;
            }
          },
          // startSynthesizer() {
          //   // if (!this.synthesizer) {
          //     let speechConfig =
          //       this.SpeechSDK.SpeechConfig.fromAuthorizationToken(
          //         this.apiKey,
          //         this.region
          //       );

          //     let audioConfig = this.SpeechSDK.AudioConfig.fromSpeakerOutput(
          //       this.player
          //     );

          //     this.synthesizer = new this.SpeechSDK.SpeechSynthesizer(
          //       speechConfig,
          //       audioConfig
          //     );
          //   // } else {
          //     // this.synthesizer.dispose(false);
          //   // }
          // },
          stopSpeaking() {
            if (this.player) {
              this.player.pause();
              this.speaking = false;
            }
          },
          changeVoice() {
            let items = this.voiceItems.filter((item) => {
              return item.startsWith(this.lang.value);
            });
            this.voice = items[0];
            this.filterVoiceItems = items;
          },
        },
        computed: {},
        watch: {},
        destroyed() {},
      });
    </script>
  </body>
</html>
